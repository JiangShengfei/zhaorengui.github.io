<p>
:nil @:t ::t |:t ^:nil -:t f:t *:t &lt;:t
</p>
---
layout: post
title:  php 跨域问题解决
author: zrg
description: 
excerpt: 
comments: false
categories: 
- PHP
tags:
- PHP
---

<p>
感谢您阅读此文，如果您发现任何错误，请发邮件至 zrg1390556487@gmail.com，谢谢！
</p>

<div id="outline-container-org46f0ad6" class="outline-2">
<h2 id="org46f0ad6"><span class="section-number-2">1</span> 问题概述</h2>
<div class="outline-text-2" id="text-1">
<pre class="example">
现代浏览器针对不同域名之间的ajax请求，一般情况下会阻止你获取到ajax返回内容（即使是1.a.com和2.a.com也算跨域）。

</pre>
</div>
</div>
<div id="outline-container-org45c9cf3" class="outline-2">
<h2 id="org45c9cf3"><span class="section-number-2">2</span> Ajax 请求跨域问题解决</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org9336d27" class="outline-3">
<h3 id="org9336d27"><span class="section-number-3">2.1</span> 客户端代码</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>客户端请求代码</label><pre class="src src-emacs-lisp">// &#19978;&#20256;&#25991;&#20214;
function upload_idcard_file(_this,type){
    var formData = new FormData()<span style="color: #5f615c; font-style: italic;">;</span>
    formData.append('type',type)<span style="color: #5f615c; font-style: italic;">;</span>
    formData.append('file',_this.files[0])<span style="color: #5f615c; font-style: italic;">;</span>
    $.ajax({
        url: '{$upload_file_url}',
        type: 'POST',
        dataType: 'json',
        data: formData,
        cache: false,
        contentType : false,
        processData : false,
        headers : {<span style="color: #5c3566;">"access_token"</span> : <span style="color: #5c3566;">"{$access_token}"</span>},
        success:function(d){
            var img_url = d.data<span style="color: #5f615c; font-style: italic;">;</span>
            img_url = 'http:'+img_url<span style="color: #5f615c; font-style: italic;">;</span>
            load_img(_this.id,img_url)<span style="color: #5f615c; font-style: italic;">;</span>
        },
        error:function(err){
            //
        }
    })<span style="color: #5f615c; font-style: italic;">;</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org7d7168f" class="outline-3">
<h3 id="org7d7168f"><span class="section-number-3">2.2</span> 服务端代码</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org437cf16" class="outline-4">
<h4 id="org437cf16"><span class="section-number-4">2.2.1</span> 解决方式一</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>粗糙解决方式</label><pre class="src src-emacs-lisp">// &#20801;&#35768;&#25152;&#26377;&#36328;&#22495;&#35831;&#27714;
header('Access-Control-Allow-Origin: *')<span style="color: #5f615c; font-style: italic;">;</span>
// &#21482;&#20801;&#35768;http://www.baidu.com&#19979;&#21457;&#26469;&#30340;&#36328;&#22495;&#35831;&#27714;
// header('Access-Control-Allow-Origin: http://www.baidu.com')<span style="color: #5f615c; font-style: italic;">;</span>
// &#35774;&#32622;&#25903;&#25345;&#30340;http&#35831;&#27714;&#26041;&#24335;
header('Access-Control-Allow-Methods:POST,GET,OPTIONS,PUT,DELETE')<span style="color: #5f615c; font-style: italic;">;</span>
// &#21709;&#24212;&#22836; &#35831;&#25353;&#29031;&#33258;&#24049;&#38656;&#27714;&#28155;&#21152;
header('Access-Control-Allow-Headers:access_token')<span style="color: #5f615c; font-style: italic;">; </span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org383920c" class="outline-4">
<h4 id="org383920c"><span class="section-number-4">2.2.2</span> 解决方式二</h4>
<div class="outline-text-4" id="text-2-2-2">
<pre class="example">
方式一中单纯使用*或者具体域名，在开发接口时显得不太科学，这时候我们需要进行动态的判断处理。

</pre>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>动态判断处理跨域问题</label><pre class="src src-emacs-lisp">// &#23450;&#20041;&#19968;&#20010;&#20801;&#35768;&#36328;&#22495;&#35831;&#27714;&#25509;&#21475;&#30340;&#22495;&#21517;&#21015;&#34920;&#65292;&#36825;&#37324;&#20320;&#21487;&#20197;&#29992;&#37197;&#32622;&#20063;&#21487;&#20197;&#29992;&#20854;&#23427;&#24418;&#24335;&#65292;&#25105;&#36825;&#37324;&#21482;&#26159;&#29992;$GLOBALS&#31616;&#21333;&#28436;&#31034;&#19968;&#19979;
$GLOBALS['API_ALLOW_ORIGINS'] = array(
    'baidu.com',
    'bing.com'
)<span style="color: #5f615c; font-style: italic;">;</span>
// &#21028;&#26029;&#26159;&#21542;&#26377;origin&#35831;&#27714;&#22836;
if(isset($_SERVER['HTTP_ORIGIN']))
{
    // &#36941;&#21382;&#22495;&#21517;&#21015;&#34920;&#21028;&#26029;
    foreach($GLOBALS['API_ALLOW_ORIGINS'] as $domain)
    {
        if($_SERVER['HTTP_ORIGIN'] === $domain || substr($_SERVER['HTTP_ORIGIN'], -strlen($domain) - 1) === '.' . $domain)
        {
            header('Access-Control-Allow-Origin: ' . $_SERVER['HTTP_ORIGIN'])<span style="color: #5f615c; font-style: italic;">;</span>
            break<span style="color: #5f615c; font-style: italic;">;</span>
        }
    }
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org9d9be26" class="outline-2">
<h2 id="org9d9be26"><span class="section-number-2">3</span> Session 跨域问题解决</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">ini_set('session.cookie_domain', '.a.com')<span style="color: #5f615c; font-style: italic;">;</span>
header('Access-Control-Allow-Credentials: true')<span style="color: #5f615c; font-style: italic;">;</span>
</pre>
</div>
</div>
</div>
